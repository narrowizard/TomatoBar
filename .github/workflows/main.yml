name: build-and-release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: macos-12

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set version
        run: |
          # è·å– fork ä»“åº“åç§°
          REPO_NAME=$(echo ${{ github.repository }} | cut -d'/' -f1)
          # è·å–ç‰ˆæœ¬å·ï¼ˆå»æ‰ v å‰ç¼€ï¼‰
          VERSION=$(git describe --tags --match 'v*' | sed 's/^v//')
          # è®¾ç½®è¾“å‡ºå˜é‡
          echo "repo_name=$REPO_NAME" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_ENV
          echo "full_name=${REPO_NAME}-TomatoBar" >> $GITHUB_ENV

      - name: Build
        env:
          DEVELOPER_DIR: /Applications/Xcode_14.1.app/Contents/Developer
        run: |
          # æ„å»ºåº”ç”¨
          xcodebuild archive -project TomatoBar.xcodeproj \
                             -scheme TomatoBar \
                             -configuration Release \
                             -archivePath TomatoBar.xcarchive \
                             MARKETING_VERSION=${{ env.version }}

          # å¯¼å‡ºåº”ç”¨
          xcodebuild -archivePath TomatoBar.xcarchive \
                     -exportArchive \
                     -exportOptionsPlist export_options.plist \
                     -exportPath .

          # é‡å‘½ååº”ç”¨ä»¥åŒºåˆ† fork ç‰ˆæœ¬
          mv "TomatoBar.app" "${{ env.full_name }}.app"

          # æ‰“åŒ…
          zip -r "${{ env.full_name }}-${{ env.version }}.zip" "${{ env.full_name }}.app"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: "${{ env.full_name }} v${{ env.version }}"
          body: |
            ## ${{ env.full_name }} v${{ env.version }}

            è¿™æ˜¯ ${{ env.repo_name }} çš„ TomatoBar fork ç‰ˆæœ¬ã€‚

            ### ä¸»è¦å˜åŒ–
            - åŸºäº [åŸå§‹ TomatoBar](https://github.com/ivoronin/TomatoBar) v${{ env.version }}
            - æ·»åŠ äº†è‡ªå®šä¹‰ API ç«¯ç‚¹æ”¯æŒ
            - æ”¯æŒå·¥ä½œå®Œæˆè®°å½•ä¸Šä¼ åˆ° https://tomast.narro.cn

            ### å®‰è£…è¯´æ˜
            1. ä¸‹è½½ `${{ env.full_name }}-${{ env.version }}.zip`
            2. è§£å‹ç¼©å¹¶å°†åº”ç”¨æ‹–åˆ° Applications æ–‡ä»¶å¤¹
            3. å¦‚æœç³»ç»Ÿæç¤ºæ— æ³•éªŒè¯å¼€å‘è€…ï¼Œè¯·åœ¨ç³»ç»Ÿåå¥½è®¾ç½®ä¸­å…è®¸è¿è¡Œ

            ### ä½¿ç”¨è¯´æ˜
            åœ¨è®¾ç½®ä¸­é…ç½®ä½ çš„ API ç«¯ç‚¹å³å¯å¼€å§‹ä½¿ç”¨å¢å¼ºåŠŸèƒ½ã€‚

            ---

            ğŸ¤– Generated with GitHub Actions
          files: "${{ env.full_name }}-${{ env.version }}.zip"
          draft: false
          prerelease: false
